{% extends "common/base.html" %}
{% load crispy_forms_tags %}
{% load crispy_forms_filters %}
{% load static %}
{% load i18n %}

{% block title %}
Create Announcement
{% endblock %}


{% block content %}
<h2>Create Announcement</h2>
<hr>

<form method="post">
  {% csrf_token %}
  {{ form.title|as_crispy_field }}
  {{ form.body|as_crispy_field }}
  {{ form.categories|as_crispy_field }}
  {{ form.mailing_lists|as_crispy_field }}
  <div id="div_id_mailing_lists_select" class="form-group">
    <div class="row">
      <div class="col">
        <div class="card">
          <div class="card-header">
            <div class="row">
              <div class="col-3">
                <label for="div_id_mailing_lists_filter">
                  Mailing Lists
                </label>
              </div>
              <div class="col-8">
                <div class="input-group input-group-sm">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                  </div>
                  <input type="text" name="mailing_lists_filter" maxlength="100" class="textinput form-control" id="id_mailing_lists_filter" autocomplete="off">
                </div>
              </div>
            </div>
          </div>
          <div class="card-body" style="min-height: 140px;">
            <div id="mailing_lists_search_results"></div>
          </div>
        </div>
      </div>
      <div class="align-self-center">
        <i class="fas fa-exchange-alt"></i>
      </div>
      <div class="col">
        <div class="card">
          <div class="card-header" style="min-height: 56.8px;">
            To Email
          </div>
          <div class="card-body" style="min-height: 140px;">
            <div id="selected_mailing_lists"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="div_id_categories_select" class="form-group">
    <div class="row">
      <div class="col">
        <div class="card">
          <div class="card-header">
            <div class="row">
              <div class="col-3">
                <label for="div_id_categories_filter">
                  Categories
                </label>
              </div>
              <div class="col-8">
                <div class="input-group input-group-sm">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                  </div>
                  <input type="text" name="categories_filter" maxlength="100" class="textinput form-control" id="id_categories_filter" autocomplete="off">
                </div>
              </div>
            </div>
          </div>
          <div class="card-body" style="min-height: 140px;">
            <div id="categories_search_results"></div>
          </div>
        </div>
      </div>
      <div class="align-self-center">
        <i class="fas fa-exchange-alt"></i>
      </div>
      <div class="col">
        <div class="card">
          <div class="card-header" style="min-height: 56.8px;">
            Selected
          </div>
          <div class="card-body" style="min-height: 140px;">
            <div id="selected_categories"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <hr>
  <input class="btn btn-primary" type="submit" value="Create" />
  <a class="btn btn-secondary" href="{% url 'announcement-list' %}" role="button">Cancel</a>
</form>

<script>
  var selections = {{ selections|safe }};
  selections['categories']['available'] = new Set(selections['categories']['full_list'])
  selections['categories']['selected'] = new Set()

  selections['mailing_lists']['available'] = new Set(selections['mailing_lists']['full_list'])
  selections['mailing_lists']['selected'] = new Set()

  function createSearchResult(value, selection) {
    $(`#${selection}_search_results`).append(
      `
      <div id="search_result_${value.replaceAll(' ', '_')}" class="d-inline">
        <a href="#", title="Add tag">
          <span class="badge badge-pill badge-secondary"><i class="fas fa-plus"></i> ${value}</span>
        </a>
      </div>
      `
    )
    $('#search_result_' + value.replaceAll(' ', '_')).click(function(e) {
      e.preventDefault();
      createSelectedResult(value, selection);
      selections[selection]['selected'].add(value);
      $(`#id_${selection}_${selections[selection]['full_list'].indexOf(value)}`).attr('checked', true);
      $(this).remove();
    })
  }

  function createSelectedResult(value, selection) {
    $(`#selected_${selection}`).append(
      `
      <div id="selected_result_${value.replaceAll(' ', '_')}" class="d-inline">
        <a href="#", title="Add tag">
          <span class="badge badge-pill badge-primary"><i class="fas fa-minus"></i> ${value}</span>
        </a>
      </div>
      `
    )
    $('#selected_result_' + value.replaceAll(' ', '_')).click(function(e) {
      e.preventDefault();
      if (selections[selection]['available'].has(value)) {
        createSearchResult(value, selection);
      }
      selections[selection]['selected'].delete(value);
      $(`#id_${selection}_${selections[selection]['full_list'].indexOf(value)}`).attr('checked', false);
      $(this).remove();
    })
  }

  function setUpSelections(selection) {
    // $('#div_id_' + selection).hide()
    selections[selection]['full_list'].forEach(element => {
      createSearchResult(element, selection);
    });
    $(`#id_${selection}_filter`).keyup(function(e) {
      var full_list = selections[selection]['full_list']
      var value = e.target.value;
      if (!value.length) {
        selections[selection]['available'] = new Set(full_list);
        var remaining = selections[selection]['available'].difference(selections[selection]['selected'])
        remaining.forEach(element => {
          $("#search_result_" + element.replaceAll(' ', '_')).remove();
          createSearchResult(element, selection);
        });
        return;
      }

      var matches = new Set();
      full_list.forEach(element => {
        if (element.toLowerCase().startsWith(value.toLowerCase())) {
          if (!selections[selection]['selected'].has(element)){
            matches.add(element)
          }
        }
      });

      var to_remove = selections[selection]['available'].difference(matches);
      to_remove.forEach(element => {
        $("#search_result_" + element.replaceAll(' ', '_')).remove();
      });

      var to_add = matches.difference(selections[selection]['available']);
      to_add.forEach(element => {
        createSearchResult(element, selection);
      });

      selections[selection]['available'] = matches;
    })
  }

  $(document).ready(function() {
    setUpSelections('categories')
    setUpSelections('mailing_lists')
  })
</script>
{% endblock %}